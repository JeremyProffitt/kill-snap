AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Image thumbnail generation service with S3 and DynamoDB

Parameters:
  S3BucketName:
    Type: String
    Description: Name of the S3 bucket for images
    Default: image-thumbnails-bucket

  AdminUsername:
    Type: String
    Description: Admin username for initial setup
    Default: admin

  AdminPassword:
    Type: String
    Description: Admin password for initial setup
    NoEcho: true

  DomainName:
    Type: String
    Description: Custom domain name for website and API
    Default: 'DISABLED'

  HostedZoneId:
    Type: String
    Description: Route53 Hosted Zone ID
    Default: 'DISABLED'

  CloudFrontCertificateArn:
    Type: String
    Description: ARN of ACM certificate in us-east-1 for CloudFront
    Default: 'DISABLED'

  OpenAIApiKey:
    Type: String
    Description: OpenAI API key for GPT-4o vision analysis (optional)
    NoEcho: true
    Default: ''

Resources:
  # S3 buckets are created by the deployment pipeline using AWS CLI
  # ImageBucket: $S3_BUCKET (from GitHub variables)
  # WebsiteBucket: $S3_BUCKET-web

  # DynamoDB table for image metadata
  ImageMetadataTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: kill-snap-ImageMetadata
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: ImageGUID
          AttributeType: S
        - AttributeName: Reviewed
          AttributeType: S
        - AttributeName: Status
          AttributeType: S
        - AttributeName: ProjectID
          AttributeType: S
      KeySchema:
        - AttributeName: ImageGUID
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ReviewedIndex
          KeySchema:
            - AttributeName: Reviewed
              KeyType: HASH
            - AttributeName: ImageGUID
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: Status
              KeyType: HASH
            - AttributeName: ImageGUID
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ProjectIndex
          KeySchema:
            - AttributeName: ProjectID
              KeyType: HASH
            - AttributeName: ImageGUID
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # DynamoDB table for users
  UsersTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: kill-snap-Users
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: Username
          AttributeType: S
      KeySchema:
        - AttributeName: Username
          KeyType: HASH

  # DynamoDB table for review groups
  ReviewGroupsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: kill-snap-ReviewGroups
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: ReviewID
          AttributeType: S
        - AttributeName: ImageGUID
          AttributeType: S
      KeySchema:
        - AttributeName: ReviewID
          KeyType: HASH
        - AttributeName: ImageGUID
          KeyType: RANGE

  # DynamoDB table for projects
  ProjectsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: kill-snap-Projects
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: ProjectID
          AttributeType: S
      KeySchema:
        - AttributeName: ProjectID
          KeyType: HASH

  # Lambda function for thumbnail generation
  ThumbnailFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      FunctionName: ImageThumbnailGenerator
      Runtime: provided.al2023
      CodeUri: lambda/thumbnail/
      Handler: bootstrap
      MemorySize: 512
      Timeout: 90
      Environment:
        Variables:
          BUCKET_NAME: !Ref S3BucketName
          DYNAMODB_TABLE: !Ref ImageMetadataTable
          OPENAI_API_KEY: !Ref OpenAIApiKey
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:DeleteObject
                - s3:ListBucket
              Resource:
                - !Sub 'arn:aws:s3:::${S3BucketName}/*'
                - !Sub 'arn:aws:s3:::${S3BucketName}'
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:Scan
              Resource: !GetAtt ImageMetadataTable.Arn

  # Lambda function for project zip generation
  ZipGeneratorFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      FunctionName: ProjectZipGenerator
      Runtime: provided.al2023
      CodeUri: lambda/zip/
      Handler: bootstrap
      MemorySize: 1024
      Timeout: 900  # 15 minutes for large zip generation
      EphemeralStorage:
        Size: 10240  # 10GB ephemeral storage for temp zip files
      Environment:
        Variables:
          BUCKET_NAME: !Ref S3BucketName
          IMAGE_TABLE: !Ref ImageMetadataTable
          PROJECT_TABLE: !Ref ProjectsTable
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:ListBucket
              Resource:
                - !Sub 'arn:aws:s3:::${S3BucketName}/*'
                - !Sub 'arn:aws:s3:::${S3BucketName}'
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
                - dynamodb:Query
              Resource:
                - !GetAtt ImageMetadataTable.Arn
                - !Sub ${ImageMetadataTable.Arn}/index/*
                - !GetAtt ProjectsTable.Arn

  # Lambda function for nightly DynamoDB-S3 sync (removes orphaned DynamoDB records)
  SyncFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      FunctionName: DynamoDBSyncFunction
      Runtime: provided.al2023
      CodeUri: lambda/sync/
      Handler: bootstrap
      MemorySize: 256
      Timeout: 900  # 15 minutes max for scanning large tables
      Environment:
        Variables:
          BUCKET_NAME: !Ref S3BucketName
          IMAGE_TABLE: !Ref ImageMetadataTable
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:HeadObject
                - s3:ListBucket
              Resource:
                - !Sub 'arn:aws:s3:::${S3BucketName}/*'
                - !Sub 'arn:aws:s3:::${S3BucketName}'
            - Effect: Allow
              Action:
                - dynamodb:Scan
                - dynamodb:DeleteItem
              Resource:
                - !GetAtt ImageMetadataTable.Arn
      Events:
        NightlySync:
          Type: Schedule
          Properties:
            Schedule: cron(0 7 * * ? *)  # 2am EST / 7am UTC daily
            Description: Nightly sync to remove orphaned DynamoDB records
            Enabled: true

  # API Gateway REST API
  ImageReviewApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization'"
        AllowOrigin: "'*'"

  # Lambda function for API backend
  ApiFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      FunctionName: ImageReviewApi
      Runtime: provided.al2023
      CodeUri: lambda/api/
      Handler: bootstrap
      MemorySize: 256
      Timeout: 60
      Environment:
        Variables:
          BUCKET_NAME: !Ref S3BucketName
          IMAGE_TABLE: !Ref ImageMetadataTable
          USERS_TABLE: !Ref UsersTable
          REVIEW_GROUPS_TABLE: !Ref ReviewGroupsTable
          PROJECTS_TABLE: !Ref ProjectsTable
          ADMIN_USERNAME: !Ref AdminUsername
          ADMIN_PASSWORD: !Ref AdminPassword
          OPENAI_API_KEY: !Ref OpenAIApiKey
          ZIP_LAMBDA_NAME: !Ref ZipGeneratorFunction
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:DeleteObject
                - s3:ListBucket
              Resource:
                - !Sub 'arn:aws:s3:::${S3BucketName}/*'
                - !Sub 'arn:aws:s3:::${S3BucketName}'
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:Query
                - dynamodb:Scan
              Resource:
                - !GetAtt ImageMetadataTable.Arn
                - !Sub ${ImageMetadataTable.Arn}/index/*
                - !GetAtt UsersTable.Arn
                - !GetAtt ReviewGroupsTable.Arn
                - !GetAtt ProjectsTable.Arn
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource:
                - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:ImageReviewApi'
                - !GetAtt ZipGeneratorFunction.Arn
            - Effect: Allow
              Action:
                - logs:FilterLogEvents
              Resource:
                - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/ProjectZipGenerator:*'
      Events:
        Login:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/login
            Method: POST
        ListImages:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/images
            Method: GET
        UpdateImage:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/images/{imageId}
            Method: PUT
        DeleteImage:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/images/{imageId}
            Method: DELETE
        GetPresignedUrl:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/images/{imageId}/download
            Method: GET
        ListProjects:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects
            Method: GET
        CreateProject:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects
            Method: POST
        AddToProject:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}/images
            Method: POST
        GetProjectImages:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}/images
            Method: GET
        GenerateZip:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}/generate-zip
            Method: POST
        GetZipDownload:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}/zips/{zipKey}/download
            Method: GET
        GetZipLogs:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}/zip-logs
            Method: GET
        UpdateProject:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}
            Method: PUT
        DeleteProject:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}
            Method: DELETE
        DeleteZip:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}/zips/{zipKey}
            Method: DELETE
        DeleteAllZips:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/projects/{projectId}/zips
            Method: DELETE
        UndeleteImage:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/images/{imageId}/undelete
            Method: POST
        RegenerateAI:
          Type: Api
          Properties:
            RestApiId: !Ref ImageReviewApi
            Path: /api/images/{imageId}/regenerate-ai
            Method: POST

  # CloudFront Origin Access Control
  CloudFrontOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Condition: HasCustomDomain
    Properties:
      OriginAccessControlConfig:
        Name: !Sub ${AWS::StackName}-OAC
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: HasCustomDomain
    Properties:
      DistributionConfig:
        Enabled: true
        HttpVersion: http2
        DefaultRootObject: index.html
        Aliases:
          - !Ref DomainName
        ViewerCertificate:
          AcmCertificateArn: !Ref CloudFrontCertificateArn
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        Origins:
          # S3 Origin for website
          - Id: S3Origin
            DomainName: !Sub ${S3BucketName}-web.s3.${AWS::Region}.amazonaws.com
            OriginAccessControlId: !Ref CloudFrontOAC
            S3OriginConfig: {}
          # API Gateway Origin
          - Id: APIOrigin
            DomainName: !Sub ${ImageReviewApi}.execute-api.${AWS::Region}.amazonaws.com
            OriginPath: /prod
            CustomOriginConfig:
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
        CacheBehaviors:
          # API behavior
          - PathPattern: /api/*
            TargetOriginId: APIOrigin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - POST
              - PATCH
              - DELETE
            CachedMethods:
              - GET
              - HEAD
            Compress: true
            ForwardedValues:
              QueryString: true
              Headers:
                - Authorization
                - Content-Type
              Cookies:
                Forward: all
            MinTTL: 0
            DefaultTTL: 0
            MaxTTL: 0
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html

  # Route53 Record for main domain
  DomainDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: HasCustomDomainAndHostedZone
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt CloudFrontDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID (constant)
        EvaluateTargetHealth: false

  # S3 Bucket Policy (must be after CloudFrontDistribution)
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: HasCustomDomain
    Properties:
      Bucket: !Sub ${S3BucketName}-web
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub arn:aws:s3:::${S3BucketName}-web/*
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}

  # CloudFront OAC for Image Bucket (always created, not dependent on custom domain)
  ImageBucketOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub ${AWS::StackName}-ImageBucket-OAC
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # CloudFront Distribution for Image Bucket (always created for image serving)
  ImageCDN:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        HttpVersion: http2
        Comment: !Sub "Image CDN for ${S3BucketName}"
        Origins:
          - Id: ImageBucketOrigin
            DomainName: !Sub ${S3BucketName}.s3.${AWS::Region}.amazonaws.com
            OriginAccessControlId: !Ref ImageBucketOAC
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: ImageBucketOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized managed policy
        PriceClass: PriceClass_100

  # Bucket Policy for Image Bucket to allow CloudFront access
  ImageBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3BucketName
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub arn:aws:s3:::${S3BucketName}/*
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${ImageCDN}

Conditions:
  HasCustomDomain: !Not [!Equals [!Ref DomainName, 'DISABLED']]
  HasHostedZone: !Not [!Equals [!Ref HostedZoneId, 'DISABLED']]
  HasCustomDomainAndHostedZone: !And
    - !Not [!Equals [!Ref DomainName, 'DISABLED']]
    - !Not [!Equals [!Ref HostedZoneId, 'DISABLED']]

Outputs:
  ImageBucketName:
    Description: Image S3 Bucket Name
    Value: !Ref S3BucketName

  WebsiteBucketName:
    Description: Website S3 Bucket Name
    Value: !Sub ${S3BucketName}-web

  WebsiteURL:
    Description: Website URL (Direct S3)
    Value: !Sub https://${S3BucketName}-web.s3.${AWS::Region}.amazonaws.com

  ApiEndpoint:
    Description: API Gateway endpoint URL (Direct)
    Value: !Sub https://${ImageReviewApi}.execute-api.${AWS::Region}.amazonaws.com/prod

  CustomDomainURL:
    Description: Custom Domain URL (CloudFront)
    Condition: HasCustomDomain
    Value: !Sub https://${DomainName}

  CloudFrontDistributionId:
    Description: CloudFront Distribution ID
    Condition: HasCustomDomain
    Value: !Ref CloudFrontDistribution

  ImageMetadataTableName:
    Description: Image Metadata DynamoDB Table Name
    Value: !Ref ImageMetadataTable

  UsersTableName:
    Description: Users DynamoDB Table Name
    Value: !Ref UsersTable

  ReviewGroupsTableName:
    Description: Review Groups DynamoDB Table Name
    Value: !Ref ReviewGroupsTable

  ProjectsTableName:
    Description: Projects DynamoDB Table Name
    Value: !Ref ProjectsTable

  ThumbnailLambdaArn:
    Description: Thumbnail Lambda Function ARN
    Value: !GetAtt ThumbnailFunction.Arn

  ApiLambdaArn:
    Description: API Lambda Function ARN
    Value: !GetAtt ApiFunction.Arn

  ZipGeneratorLambdaArn:
    Description: Zip Generator Lambda Function ARN
    Value: !GetAtt ZipGeneratorFunction.Arn

  ImageCDNUrl:
    Description: CloudFront URL for serving images
    Value: !Sub https://${ImageCDN.DomainName}
